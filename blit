#!/usr/bin/env bash
# version configurations
BSP_SERVER_VERSION="1.0.1"

# set up vars
DATABASE_USER="root"
DATABASE_PASS=""
TOMCAT_ZIP="https://github.com/OttoHagg/brightspot-server/archive/v$BSP_SERVER_VERSION.zip"

#script status
PROGNAME=$(basename $0)
GIT_REGEX='(https?|ftp|file)://[-A-Za-z0-9\+&@#/%?=~_|!:,.;]*[-A-Za-z0-9\+&@#/%=~_|]'

validateName() {
    echo -n "Please name your project directory: "
    read PROJECT_NAME
}

# checks to see if wget is installed on a mac and installs if necessary
installWget() {
    if [ "$(uname)" == "Darwin" ]; then
        if ! brew ls --versions wget > /dev/null; then
            brew install wget
        fi
    fi
}

function error_exit
{
#	----------------------------------------------------------------
#	Function for exit due to fatal program error
#   Also removes any autogenerated files up to the point of failure
#   USE WITH EXTREME PREJUDICE
#   Accepts 1 argument:
#	  string containing descriptive error message
#	----------------------------------------------------------------
	echo "${PROGNAME}: ${1:-"Unknown Error"}" 1>&2
    rm -rf $PROJ_PATH
	exit 1
}

createProject() {
    echo -n "Git Clone URL (HTTPS): "
    read GIT_URL
    if ! [[ $GIT_URL =~ $GIT_REGEX ]] ; then
        error_exit "Git URL invalid!"
    fi
    mkdir -p ./$PROJECT_NAME
    PROJ_PATH=$(pwd)/$PROJECT_NAME
    cd $PROJECT_NAME
    # Clone in project repo and download, extract, and delete tomcat
    PROJECT_DIR=$(basename $GIT_URL)-project
    git clone $GIT_URL $PROJECT_DIR
    installWget
    wget -O tomcat.zip $TOMCAT_ZIP
    unzip ./tomcat.zip
    rm -rf ./tomcat.zip
    # create mysql schema
    mysql -u root -e "CREATE DATABASE IF NOT EXISTS ${PROJECT_NAME//[\.-]/} CHARACTER SET utf8 COLLATE utf8_general_ci;" || error_exit "MySQL not configured on PATH!"
    # update context.xml
    CONTEXT_FILE="./brightspot-server-$BSP_SERVER_VERSION/conf/context.xml"
    sed -i '' "s#DATABASE_NAME#${PROJECT_NAME//[\.-]/}#g" $CONTEXT_FILE
    sed -i '' "s#DATABASE_USER#$DATABASE_USER#g" $CONTEXT_FILE
    sed -i '' "s#DATABASE_PASS#$DATABASE_PASS#g" $CONTEXT_FILE
    sed -i '' "s#TOMCAT_PATH#$(pwd)/brightspot-server-$BSP_SERVER_VERSION#g" $CONTEXT_FILE
    cd $PROJECT_DIR
    # Maven build
    rm -rf node_modules && yarn cache clean
    mvn clean install || error_exit "Maven build FAILURE"
    #link war to root
    cd ../brightspot-server-$BSP_SERVER_VERSION/webapps
    ln -sf ../../$PROJECT_DIR/target/*.war ./ROOT.war
    # make shell scripts executable
    cd ../bin
    chmod a+x *.sh
    cd ../
    chown -R $USER *
}

start_time=`date +%s`
echo "Brightspot Installation"
while true; do
    validateName
    if [[ ! -z $PROJECT_NAME ]]; then
        createProject
        break
    else
        echo "Please enter a valid directory name"
    fi
done

echo "BRIGHTSPOT Server Setup Complete"
echo "Execution time: $(expr `date +%s` - $start_time)s"
